<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ãƒ«ãƒ¼ãƒˆGPXç”Ÿæˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    #map { height: 600px; }
    .controls { margin: 10px 0; }
    input, select, button { padding: 6px; margin-right: 5px; }
    #distanceDisplay { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ãƒ«ãƒ¼ãƒˆã‚’GPXã§ä¿å­˜ï¼ˆOpenRouteServiceä½¿ç”¨ï¼‰</h2>

  <p>
    ã“ã®ã‚µã‚¤ãƒˆã§ã¯ã€<strong>OpenRouteService</strong> ã®APIã‚’ä½¿ã£ã¦ã€<strong>å¾’æ­©ãƒ»è‡ªè»¢è»Šãƒ»è»Šã®é“ãªã‚Šãƒ«ãƒ¼ãƒˆ</strong>ã‚’å–å¾—ã—ã€<strong>GPXãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜</strong>ã§ãã¾ã™ã€‚<br>
    ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã‹ã‚‰<strong>APIã‚­ãƒ¼ã‚’å–å¾—</strong>ã—ã€è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆ1æ—¥ã‚ãŸã‚Š<strong>2000å›ã¾ã§ç„¡æ–™</strong>ã§åˆ©ç”¨ã§ãã¾ã™ï¼‰ï¼š<br>
    ğŸ”‘ <a href="https://account.heigit.org/manage/key" target="_blank">https://account.heigit.org/manage/key</a>
  </p>

  <div class="controls">
    <label>ğŸ”‘ APIã‚­ãƒ¼: 
      <input id="apiKey" type="text" size="40" placeholder="OpenRouteService APIã‚­ãƒ¼ã‚’å…¥åŠ›" />
      <button onclick="saveApiKey()">ğŸ’¾ ä¿å­˜</button>
      <button onclick="clearApiKey()">âŒ å‰Šé™¤</button>
    </label>
    <label>ğŸš— ãƒ¢ãƒ¼ãƒ‰: 
      <select id="mode">
        <option value="foot-walking">å¾’æ­©</option>
        <option value="cycling-regular">è‡ªè»¢è»Š</option>
        <option value="driving-car">è»Š</option>
      </select>
    </label>
    <label>ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«å: 
      <input id="filename" type="text" placeholder="ä¾‹: my-route" size="20" />
    </label>
    <label>ğŸ“ å‡ºç™ºç‚¹: 
      <input id="startCoord" type="text" placeholder="ç·¯åº¦,çµŒåº¦ ä¾‹: 35.6,139.7" size="30" oninput="updateMarkerFromInput('start')" />
    </label>
    <label>ğŸ åˆ°ç€ç‚¹: 
      <input id="endCoord" type="text" placeholder="ç·¯åº¦,çµŒåº¦ ä¾‹: 35.7,139.8" size="30" oninput="updateMarkerFromInput('end')" />
    </label>
    <button onclick="useCurrentLocation()">ç¾åœ¨åœ°ã‚’å‡ºç™ºç‚¹ã«</button>
    <button onclick="resetMap()">ãƒªã‚»ãƒƒãƒˆ</button>
    <button onclick="downloadGPX()">GPXã¨ã—ã¦ä¿å­˜</button>
    <div id="distanceDisplay"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <script>
    const map = L.map('map').setView([35.681236, 139.767125], 13); // æ±äº¬é§…
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let waypoints = [];
    let routeLine = null;
    let markers = [];

    map.on('click', function(e) {
      if (waypoints.length < 2) {
        const point = [e.latlng.lng, e.latlng.lat];
        const index = waypoints.length;
        waypoints.push(point);
        const type = index === 0 ? 'start' : 'end';
        markers[index] = addMarker(e.latlng, type);
        updateInputFields();
      }
    });

    function addMarker(latlng, type) {
      const color = type === 'start' ? 'green' : 'red';
      const marker = L.circleMarker(latlng, {
        radius: 8,
        color: 'white',
        fillColor: color,
        fillOpacity: 1,
        weight: 2
      }).addTo(map).bindPopup(type === 'start' ? 'å‡ºç™ºç‚¹' : 'åˆ°ç€ç‚¹');
      return marker;
    }

    function updateInputFields() {
      if (waypoints[0]) {
        document.getElementById("startCoord").value = `${waypoints[0][1]},${waypoints[0][0]}`;
      }
      if (waypoints[1]) {
        document.getElementById("endCoord").value = `${waypoints[1][1]},${waypoints[1][0]}`;
      }
    }

    function updateMarkerFromInput(type) {
      const input = document.getElementById(type === 'start' ? 'startCoord' : 'endCoord').value.trim();
      const parts = input.split(',').map(s => s.trim());
      if (parts.length !== 2) return;

      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      if (isNaN(lat) || isNaN(lng)) return;

      const index = type === 'start' ? 0 : 1;

      while (waypoints.length <= index) {
        waypoints.push(null);
      }

      waypoints[index] = [lng, lat];

      if (markers[index]) {
        map.removeLayer(markers[index]);
      }

      markers[index] = addMarker([lat, lng], type);
    }

    function resetMap() {
      waypoints = [];
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      if (routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
      }
      document.getElementById('distanceDisplay').innerText = '';
      document.getElementById('startCoord').value = '';
      document.getElementById('endCoord').value = '';
    }

    async function downloadGPX() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const mode = document.getElementById('mode').value;

      if (!apiKey) {
        alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (waypoints.length !== 2) {
        alert("å‡ºç™ºç‚¹ã¨åˆ°ç€ç‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const url = `https://api.openrouteservice.org/v2/directions/${mode}/geojson`;

      try {
        const res = await axios.post(url, {
          coordinates: waypoints
        }, {
          headers: {
            "Authorization": apiKey,
            "Content-Type": "application/json"
          }
        });

        const coords = res.data.features[0].geometry.coordinates;
        const distanceKm = (res.data.features[0].properties.summary.distance / 1000).toFixed(2);
        document.getElementById('distanceDisplay').innerText = `ğŸ›£ï¸ è·é›¢: ${distanceKm} km`;

        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(coords.map(p => [p[1], p[0]]), { color: 'blue', weight: 5 }).addTo(map);

        const gpxContent = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="MyApp" xmlns="http://www.topografix.com/GPX/1/1">
  <trk><name>Route</name><trkseg>
    ${coords.map(p => `<trkpt lat="${p[1]}" lon="${p[0]}" />`).join('\n')}
  </trkseg></trk>
</gpx>`;

        const blob = new Blob([gpxContent], { type: "application/gpx+xml" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        const filename = document.getElementById('filename').value.trim() || `route_${mode}`;
        a.download = `${filename}.gpx`;
        a.click();

      } catch (err) {
        console.error(err);
        alert("ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã‚„åº§æ¨™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    }

    function saveApiKey() {
      const key = document.getElementById('apiKey').value.trim();
      if (key) {
        localStorage.setItem('ors_api_key', key);
        alert("âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
      }
    }

    function clearApiKey() {
      localStorage.removeItem('ors_api_key');
      document.getElementById('apiKey').value = '';
      alert("ğŸ—‘ï¸ APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    window.onload = function () {
      const savedKey = localStorage.getItem('ors_api_key');
      if (savedKey) {
        document.getElementById('apiKey').value = savedKey;
      }
    };
  </script>
</body>
</html>
